<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGBA - Postular</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="logo">SGBA Postulante</div>
            <a href="dashboard.html" class="btn btn-outline">Volver</a>
        </div>
    </nav>

    <div class="container">
        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <div class="mb-4 border-bottom pb-4" style="border-bottom: 1px solid var(--border-color);">
                <h2 id="convTitle">Cargando...</h2>
                <p id="convDesc" class="text-muted">...</p>
            </div>

            <form id="applyForm">
                <input type="hidden" id="education_level" name="education_level" value="universitario">
                <!-- Simplified -->

                <h3 class="mb-4">1. Datos Personales</h3>
                <div class="flex gap-4">
                    <div class="form-group flex-1">
                        <label class="form-label">Edad</label>
                        <input type="number" name="age" id="age" class="form-control" required min="15" max="100">
                    </div>
                    <div class="form-group flex-1">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" name="phone" class="form-control" required>
                    </div>
                </div>

                <h3 class="mb-4 mt-4">2. Información Académica y Socioeconómica</h3>
                <div class="flex gap-4">
                    <div class="form-group flex-1">
                        <label class="form-label">Promedio Actual (0-10)</label>
                        <input type="number" name="gpa" id="gpa" class="form-control" required min="0" max="10"
                            step="0.1">
                    </div>
                    <div class="form-group flex-1">
                        <label class="form-label">Ingresos Mensuales Familiares ($)</label>
                        <input type="number" name="income" id="income" class="form-control" required min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Motivo de la Solicitud</label>
                    <textarea name="motive" class="form-control" rows="4" required
                        placeholder="Explique por qué debería recibir esta beca..."></textarea>
                </div>

                <div class="alert hidden" id="validationAlert"
                    style="padding: 1rem; margin-bottom: 1rem; border-radius: 4px; background: #fee2e2; color: #991b1b;">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Enviar Solicitud</button>
            </form>
        </div>
    </div>

    <script src="../../js/core.js"></script>
    <script>
        AuthManager.requireRole('postulante');
        const user = AuthManager.getCurrentUser();

        // Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const convId = params.get('id');

        const convs = StorageManager.get(APP_KEYS.CONVOCATORIAS) || [];
        const conv = convs.find(c => c.id === convId);

        if (!conv) {
            alert('Convocatoria no encontrada');
            window.location.href = 'dashboard.html';
        } else {
            document.getElementById('convTitle').textContent = 'Postulando a: ' + conv.title;
            document.getElementById('convDesc').textContent = conv.description;
        }

        document.getElementById('applyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // --- Auto Validation Logic ---
            const age = parseInt(formData.get('age'));
            const income = parseFloat(formData.get('income'));
            const gpa = parseFloat(formData.get('gpa'));

            let isApta = 'apta';
            let status = 'enviada';

            // Example Rule: Age < 18 or Income > 5000 -> Auto Reject (No apta)
            // But usually "No Apta" just means it failed validation but is recorded.
            // Let's say if it's "No Apta", it's automatically rejected.

            if (income > 50000 || gpa < 6) { // Abstract values for demo
                isApta = 'no_apta';
                status = 'rechazada'; // Auto reject
            }

            const solicitud = {
                id: crypto.randomUUID(),
                convocatoriaId: conv.id,
                applicantId: user.id,
                status: status,
                submissionDate: new Date().toISOString().split('T')[0],
                formData: {
                    age, income, gpa,
                    phone: formData.get('phone'),
                    motive: formData.get('motive')
                },
                autoValidation: isApta,
                evaluation: null
            };

            // Save
            StorageManager.add(APP_KEYS.SOLICITUDES, solicitud);

            alert(isApta === 'apta'
                ? 'Solicitud enviada con éxito.'
                : 'Solicitud enviada, pero no cumple con los criterios automáticos (Rechazada).');

            window.location.href = 'dashboard.html';
        });
    </script>
</body>

</html>