<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGBA - Mi Panel</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="logo">SGBA Postulante</div>
            <div class="nav-links" style="align-items: center;">
                <span>Hola, <strong id="userName">User</strong></span>
                <button onclick="AuthManager.logout()" class="btn btn-outline" style="font-size: 0.8rem;">Cerrar
                    Sesión</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="flex gap-4 mb-4">
            <button class="btn btn-primary" onclick="showSection('convocatorias')">Becas Disponibles</button>
            <button class="btn btn-outline" onclick="showSection('mis-solicitudes')">Historial</button>
        </div>

        <!-- Section: Convocatorias -->
        <div id="section-convocatorias">
            <h2 class="mb-4">Becas Disponibles</h2>
            <div id="convocatoriasList"
                style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Section: Historial -->
        <div id="section-mis-solicitudes" class="hidden">
            <h2 class="mb-4">Mis Postulaciones</h2>
            <div id="solicitudesList" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <script src="../../js/core.js"></script>
    <script>
        // Auth Check
        AuthManager.requireRole('postulante');
        const user = AuthManager.getCurrentUser();
        document.getElementById('userName').textContent = user ? user.name : 'Postulante';

        // --- UI Logic ---
        function showSection(id) {
            document.getElementById('section-convocatorias').classList.add('hidden');
            document.getElementById('section-mis-solicitudes').classList.add('hidden');

            document.getElementById('section-' + id).classList.remove('hidden');

            if (id === 'mis-solicitudes') loadHistory();
        }

        function loadConvocatorias() {
            const list = StorageManager.get(APP_KEYS.CONVOCATORIAS) || [];
            const myApps = StorageManager.get(APP_KEYS.SOLICITUDES) || [];

            // Filter open ones
            const openList = list.filter(c => c.status === 'open');

            const container = document.getElementById('convocatoriasList');
            container.innerHTML = '';

            if (openList.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay convocatorias disponibles en este momento.</p>';
                return;
            }

            openList.forEach(c => {
                // Check if already applied
                const hasApplied = myApps.find(a => a.applicantId === user.id && a.convocatoriaId === c.id);

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="badge badge-info">${c.type.toUpperCase()}</span>
                        <span class="text-muted" style="font-size: 0.8rem">Acaba: ${c.dates.end}</span>
                    </div>
                    <h3>${c.title}</h3>
                    <p class="text-muted mb-4">${c.description}</p>
                    <div class="mb-2">
                        <strong>Requisitos:</strong>
                        <ul class="text-muted" style="font-size: 0.85rem; padding-left: 1rem; list-style-type: disc;">
                            ${c.requirements.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    ${hasApplied
                        ? `<button class="btn btn-block btn-outline" disabled>Ya Postulado</button>`
                        : `<a href="apply.html?id=${c.id}" class="btn btn-primary btn-block">Postular Ahora</a>`
                    }
                `;
                container.appendChild(card);
            });
        }

        function loadHistory() {
            const apps = StorageManager.get(APP_KEYS.SOLICITUDES) || [];
            const convs = StorageManager.get(APP_KEYS.CONVOCATORIAS) || [];

            // Filter my apps
            const myApps = apps.filter(a => a.applicantId === user.id);
            const container = document.getElementById('solicitudesList');
            container.innerHTML = '';

            if (myApps.length === 0) {
                container.innerHTML = '<p class="text-muted">Aún no has realizado ninguna postulación.</p>';
                return;
            }

            myApps.forEach(a => {
                const conv = convs.find(c => c.id === a.convocatoriaId) || { title: 'Desconocido' };

                let badgeClass = 'badge-info';
                if (a.status === 'aprobada') badgeClass = 'badge-success';
                if (a.status === 'rechazada') badgeClass = 'badge-danger';
                if (a.status === 'enviada') badgeClass = 'badge-warning';

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3>${conv.title}</h3>
                            <p class="text-muted" style="font-size: 0.85rem;">Enviado el: ${a.submissionDate}</p>
                        </div>
                        <div class="text-center">
                            <span class="badge ${badgeClass}" style="font-size: 1rem;">${a.status.toUpperCase().replace('_', ' ')}</span>
                            ${a.autoValidation === 'no_apta' ? '<br><span class="text-muted" style="font-size: 0.7rem; color: var(--danger-color);">Rechazo Automático</span>' : ''}
                        </div>
                    </div>
                    ${a.evaluation && a.evaluation.comments ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <p><strong>Observaciones:</strong> ${a.evaluation.comments}</p>
                            <p><strong>Puntaje:</strong> ${a.evaluation.score}</p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }

        loadConvocatorias();
    </script>
</body>

</html>