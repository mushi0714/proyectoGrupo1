<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGBA - Panel Administrador</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="logo">SGBA Admin</div>
            <div class="nav-links" style="align-items: center;">
                <span>Bienvenido, <strong id="adminName">Admin</strong></span>
                <button onclick="AuthManager.logout()" class="btn btn-outline" style="font-size: 0.8rem;">Cerrar
                    Sesión</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="flex gap-4 mb-4">
            <button class="btn btn-primary" onclick="showSection('convocatorias')">Gestionar Convocatorias</button>
            <button class="btn btn-outline" onclick="showSection('evaluadores')">Gestionar Evaluadores</button>
            <button class="btn btn-outline" onclick="showSection('reportes')">Reportes</button>
        </div>

        <!-- Section: Convocatorias -->
        <div id="section-convocatorias">
            <div class="flex justify-between items-center mb-4">
                <h2>Convocatorias</h2>
                <button class="btn btn-primary" onclick="openModal('modalConvocatoria')">+ Nueva Convocatoria</button>
            </div>

            <div id="convocatoriasList"
                style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Section: Evaluadores -->
        <div id="section-evaluadores" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2>Evaluadores</h2>
                <button class="btn btn-primary" onclick="openModal('modalEvaluador')">+ Nuevo Evaluador</button>
            </div>

            <div class="card">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 1rem;">Nombre</th>
                            <th style="padding: 1rem;">Correo</th>
                            <th style="padding: 1rem;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="evaluadoresList">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section: Reportes -->
        <div id="section-reportes" class="hidden">
            <h2>Reportes Globales</h2>
            <div class="flex gap-4 mt-4">
                <div class="card flex-1 text-center">
                    <h3 id="stat-total-apps" style="font-size: 2rem; color: var(--primary-color);">0</h3>
                    <p class="text-muted">Total Solicitudes</p>
                </div>
                <div class="card flex-1 text-center">
                    <h3 id="stat-approved" style="font-size: 2rem; color: var(--success-color);">0</h3>
                    <p class="text-muted">Aprobadas</p>
                </div>
                <div class="card flex-1 text-center">
                    <h3 id="stat-pending" style="font-size: 2rem; color: var(--warning-color);">0</h3>
                    <p class="text-muted">Pendientes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva Convocatoria -->
    <div id="modalConvocatoria" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 500px; max-width: 90%;">
            <h3 class="mb-4">Nueva Convocatoria</h3>
            <form id="formConvocatoria">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea name="description" class="form-control" required></textarea>
                </div>
                <div class="flex gap-4">
                    <div class="form-group flex-1">
                        <label class="form-label">Tipo</label>
                        <select name="type" class="form-control" required>
                            <option value="economica">Económica</option>
                            <option value="academica">Académica</option>
                            <option value="social">Social</option>
                        </select>
                    </div>
                    <div class="form-group flex-1">
                        <label class="form-label">Fecha Cierre</label>
                        <input type="date" name="endDate" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Requisitos (separados por coma)</label>
                    <input type="text" name="requirements" class="form-control"
                        placeholder="Ej: Mayor de 18, Promedio > 8.5">
                </div>

                <div class="flex gap-2 justify-between mt-4">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('modalConvocatoria')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Nuevo Evaluador -->
    <div id="modalEvaluador" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 400px; max-width: 90%;">
            <h3 class="mb-4">Nuevo Evaluador</h3>
            <form id="formEvaluador">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Correo</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <div class="flex gap-2 justify-between mt-4">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('modalEvaluador')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../js/core.js"></script>
    <script>
        // Auth Check
        AuthManager.requireRole('admin');
        const user = AuthManager.getCurrentUser();
        document.getElementById('adminName').textContent = user ? user.name : 'Admin';

        // --- UI Logic ---
        function showSection(id) {
            document.getElementById('section-convocatorias').classList.add('hidden');
            document.getElementById('section-evaluadores').classList.add('hidden');
            document.getElementById('section-reportes').classList.add('hidden');

            document.getElementById('section-' + id).classList.remove('hidden');

            if (id === 'reportes') loadStats();
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).style.display = 'none'; }

        // --- Convocatorias Logic ---
        function loadConvocatorias() {
            const list = StorageManager.get(APP_KEYS.CONVOCATORIAS) || [];
            const container = document.getElementById('convocatoriasList');
            container.innerHTML = '';

            list.forEach(c => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="badge badge-info">${c.type.toUpperCase()}</span>
                        <span class="text-muted" style="font-size: 0.8rem">Cierre: ${c.dates.end}</span>
                    </div>
                    <h3>${c.title}</h3>
                    <p class="text-muted mb-4">${c.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="badge ${c.status === 'open' ? 'badge-success' : 'badge-danger'}">${c.status === 'open' ? 'Abierta' : 'Cerrada'}</span>
                        <button class="btn btn-outline btn-danger" onclick="deleteConvocatoria('${c.id}')">Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        document.getElementById('formConvocatoria').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const newConv = {
                id: crypto.randomUUID(),
                title: formData.get('title'),
                description: formData.get('description'),
                type: formData.get('type'),
                dates: {
                    start: new Date().toISOString().split('T')[0],
                    end: formData.get('endDate')
                },
                requirements: formData.get('requirements').split(',').map(s => s.trim()),
                status: 'open'
            };

            StorageManager.add(APP_KEYS.CONVOCATORIAS, newConv);
            closeModal('modalConvocatoria');
            e.target.reset();
            loadConvocatorias();
        });

        function deleteConvocatoria(id) {
            if (confirm('¿Estás seguro de eliminar esta convocatoria?')) {
                StorageManager.delete(APP_KEYS.CONVOCATORIAS, id);
                loadConvocatorias();
            }
        }

        // --- Evaluadores Logic ---
        function loadEvaluadores() {
            const users = StorageManager.get(APP_KEYS.USERS) || [];
            const evaluators = users.filter(u => u.role === 'evaluador');
            const container = document.getElementById('evaluadoresList');
            container.innerHTML = '';

            evaluators.forEach(e => {
                const row = document.createElement('tr');
                row.style.borderBottom = "1px solid var(--border-color)";
                row.innerHTML = `
                    <td style="padding: 1rem;">${e.name}</td>
                    <td style="padding: 1rem;">${e.username}</td>
                    <td style="padding: 1rem;">
                        <button class="btn btn-outline btn-danger" style="font-size: 0.7rem;" onclick="deleteUser('${e.id}')">Eliminar</button>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        document.getElementById('formEvaluador').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                // Manually register but with evaluator role
                const newUser = {
                    id: crypto.randomUUID(),
                    username: formData.get('email'),
                    password: formData.get('password'),
                    name: formData.get('name'),
                    role: 'evaluador'
                };

                // Basic dup check
                const users = StorageManager.get(APP_KEYS.USERS) || [];
                if (users.find(u => u.username === newUser.username)) throw new Error("Usuario ya existe");

                StorageManager.add(APP_KEYS.USERS, newUser);
                closeModal('modalEvaluador');
                e.target.reset();
                loadEvaluadores();
            } catch (err) {
                alert(err.message);
            }
        });

        function deleteUser(id) {
            if (confirm('¿Eliminar usuario?')) {
                StorageManager.delete(APP_KEYS.USERS, id);
                loadEvaluadores();
            }
        }

        // --- Stats Logic ---
        function loadStats() {
            const apps = StorageManager.get(APP_KEYS.SOLICITUDES) || [];
            document.getElementById('stat-total-apps').textContent = apps.length;
            document.getElementById('stat-approved').textContent = apps.filter(a => a.status === 'aprobada').length;
            document.getElementById('stat-pending').textContent = apps.filter(a => a.status === 'enviada' || a.status === 'en_revision').length;
        }

        // Init
        loadConvocatorias();
        loadEvaluadores();
    </script>
</body>

</html>